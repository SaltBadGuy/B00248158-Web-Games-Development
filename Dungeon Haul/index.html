<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Dungeon Haul</title>
        <script src="//cdn.jsdelivr.net/phaser/2.6.2/phaser.min.js"></script>
    </head>
    <body>
    
    <script src="Scripts/tileset.js" type="text/javascript"> 
    </script>    

    <script type="text/javascript">

    window.onload = function() {

        var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });

        function preload () {
            //Sprites
            //Player character sprite
            game.load.image('DHPC', 'Assets/DHPC.png');
            //Floor tile sprite
            game.load.image('DHFLoor', 'Assets/DHFloor.png');
            //Floor tile sprite
            game.load.image('DHWall', 'Assets/DHStoneWall1.png');
            //Wall tile sprite
            game.load.image('DHChest', 'Assets/DHChest.png');
            //Loot sprite
            game.load.image('DHEnemy', 'Assets/DHSkeleton.png');
            //Staircase sprite
            game.load.image('DHStaircase', 'Assets/DHStairs.png');
            //Scripts
            //Maze generation script
            game.load.script('tileset.js', 'Scripts/tileset.js')

        }
        
        //Used for keyboard controls
        var keyUp;
        var keyDown;
        var keyLeft;
        var keyRight;
        var keyJ;
        var keyK;
        var keyL;
        var keyM;


        //Player character and its stats
        var PC;
        var PCCURHP;
        var PCMAXHP;
        var PCSTR;
        var PCPATK;
        var PCPDEF;
        var PrevMAXHP;

        //Used to display text that updates as the code runs at designated spots so that I can more easily debug where the game breaks/crashes
        var DebugText;
        var DebugCount;

        //Used to display the player's stats
        var PCHPText;
        var PCSTRText;
        var PCPATKText;
        var PCPDEFText;


        var PCHeadEquip;
        var PCChestEquip;
        var PCWeaponEquip;

        var PCHeadEquipText;
        var PCChestEquipText;
        var PCWeaponEquipText;

        var Parry;
        var Lifesteal;
        var ArmourPierce;
        var Critical;



        function create () {

            //Plugin initialization

            //Physics system, used for player movement, collision detection and is planned to be used for particles 

            DebugCount = 0;

            //PC stat block

            //Refers to the player's maximum health. Is increased by Strength in the current prototype. Can be further increased by items 
            PCMAXHP = 100;// + (0.5 * PCSTR);
            //Refers to the player's current HP. Starts off the same as Max HP. 
            PCCURHP = PCMAXHP;

            console.log("PCMAXHP at the start of creation is " + PCMAXHP);
            //Refers to the player's STR. Is used to increase health attack and armour in this build. Can be further increased by items
            PCSTR = 30;
            //Refers to the player's physical attack. Is increased by Strength in the current prototype and has a base value of 20.
            PCPATK = 20 + PCSTR;
            PCPDEF = 5 + (0.1 * PCSTR);

            //Once all stats have been set (mainly STR in this build) recalculate max HP and set current HP to match.
            PCMAXHP = 100 + (0.5 * PCSTR);
            PCCURHP = PCMAXHP;
            console.log("PCCURHP at the end of creation is " + PCCURHP);
            console.log("PCMAXHP at the end of creation is " + PCMAXHP);
            console.log("PCSTR at the start of creation is " + PCSTR);
            console.log("PCPATK at the start of creation is " + PCPATK);
            console.log("PCPDEF at the start of creation is " + PCPDEF);

            //PC ITEMSTAT BLOCK
            //Creates a prototype for all equipment. All equipment will be based off this.
            //@constructor
            //@param Quality(Param): Comes in 4 qualities (Common, Enchanted, Masterpiece, Mythical. These give modifiers to item stat rolls.
            //@param GotEquip(Param): Is used to show that no actual equipment has been found yet. This will only be true until the player picks up an equip for that slot
            //@param PCSTRStat(Param): Is the amount of STR the item grants.
            //@param Passive1(Param): Is the passive that the item grants. For the full game, items can roll several passives. Follows the convention "Passive X(%)"
            //@param Passive1X(Param): Is the value given to X in passives ie. Passive1(Lifesteal X%) and Passive1X(5) gives Lifesteal 5%


                //Creates a PCHeadEquip (A helmet)
                PCHeadEquip = new PCEquipProto;

                //Creates a PCChestEquip (A chestplate)
                PCChestEquip = new PCEquipProto;

                //Creates a PCWeaponEquip (A chestplate)
                PCWeaponEquip = new PCEquipProto;

            //PASSIVE BLOCK
            //Creates a prototype for all passives. All passives will be based of this.
            //PassiveMod: Multiplies the result from a roll. Strong passives (particularly percentage based ones) will have low Passive mods to keep the X Values manageable
               Passive = {PassiveMod: 1, XModifies: "Plus"};

               Lifesteal = Passive;
               Lifesteal.PassiveMod = 1;



            game.stage.backgroundColor = '#000000';
            game.physics.startSystem(Phaser.Physics.Arcade);

            
            //tileset.js.doMaze();
            
            //Displays the player's current health and max health
            PCHPText = game.add.text(100, 30, "HP = " + PCCURHP + "/" + PCMAXHP + ".", {
                font: "24px Arial",
                fill: "#f8edff",
                align: "center"
            });
            PCHPText.anchor.setTo(0.5, 0.5);

            //Displays the player's strength
            PCSTRText = game.add.text(100, 60, "STR = " + PCSTR + ".", {
                font: "24px Arial",
                fill: "#ff0019",
                align: "center"
            });
            PCSTRText.anchor.setTo(0.5, 0.5);

            //Displays the player's physical attack
            PCPATKText = game.add.text(100, 90, "ATK = " + PCPATK + ".", {
                font: "24px Arial",
                fill: "#ff7000",
                align: "center"
            });
            PCPATKText.anchor.setTo(0.5, 0.5);

            //Displays the player's physical defence
            PCPDEFText = game.add.text(100, 120, "DEF = " + PCPDEF + ".", {
                font: "24px Arial",
                fill: "#ffd100",
                align: "center"
            });
            PCPDEFText.anchor.setTo(0.5, 0.5);


            //Displays the stats of the player's head equipment (if any). Defaults to not wearing anything
            PCHeadEquipText = game.add.text(50, 500, "You have no helmet equipped.", {
                font: "12px Arial",
                fill: "#008dff",
                align: "center"
            });
            PCHPText.anchor.setTo(0.5, 0.5);

            //Displays the stats of the player's chest equipment (if any). Defaults to not wearing anything
            PCChestEquipText = game.add.text(50, 525, "You have no chestplate equipped.", {
                font: "12px Arial",
                fill: "#008dff",
                align: "center"
            });
            PCHPText.anchor.setTo(0.5, 0.5);


            //Displays the stats of the player's weapon equipment (if any). Defaults to not wearing anything
            PCWeaponEquipText = game.add.text(50, 550, "You have no weapon equipped.", {
                font: "12px Arial",
                fill: "#008dff",
                align: "center"
            });
            PCHPText.anchor.setTo(0.5, 0.5);


            DebugText = game.add.text(game.world.centerX, game.world.centerY, "You got to point /n!", {
                font: "48px Arial",
                fill: "#ff0044",
                align: "center"
            });
            DebugText.anchor.setTo(0.5, 0.5);

            DebugCount++;
            DebugText.setText("You got to point" + DebugCount + "!");
            
            //Player character creation                        
            PC = game.add.sprite(game.world.centerX, game.world.centerY, 'DHPC');
            PC.anchor.setTo(0.5, 0.5);
            
            DebugCount++;
            DebugText.setText("You got to point" + DebugCount + "!");
            
            //Enable physics for the player, this is what is used to let him move and gain a hitbox for collision detection
            
            //game.physics.arcade.enable(PC);
            
            DebugCount++;
            DebugText.setText("You got to point" + DebugCount + "!");

            //Capture input for controlling player.
            //NOTE: This captures the initial press of the key. This is intended as the movement is grid-based and this prevents players from accidentally moving more squares than they need to.
            keyUp = game.input.keyboard.addKey(Phaser.Keyboard.W);
            keyUp.onDown.add(PCMoveUp, this);

            keyDown = game.input.keyboard.addKey(Phaser.Keyboard.S);
            keyDown.onDown.add(PCMoveDown, this);

            keyLeft = game.input.keyboard.addKey(Phaser.Keyboard.A);
            keyLeft.onDown.add(PCMoveLeft, this);
            
            keyRight = game.input.keyboard.addKey(Phaser.Keyboard.D);
            keyRight.onDown.add(PCMoveRight, this);

            //Capture input for debug purposes
            //Equipping test helmet
            keyJ = game.input.keyboard.addKey(Phaser.Keyboard.J);
            keyJ.onDown.add(EquipTestHelmet, this);

            //Equipping test helmet
            keyK = game.input.keyboard.addKey(Phaser.Keyboard.K);
            keyK.onDown.add(EquipTestChestPlate, this);

            //Equipping test helmet
            keyL = game.input.keyboard.addKey(Phaser.Keyboard.L);
            keyL.onDown.add(EquipTestWeapon, this);

            //Deal damage to play
            keyM = game.input.keyboard.addKey(Phaser.Keyboard.M);
            keyM.onDown.add(HurtPlayer, this);


            
            DebugCount++;
            DebugText.setText("You got to point" + DebugCount + "!");
            
            game.input.keyboard.removeKeyCapture(Phaser.Keyboard.W);
            game.input.keyboard.removeKeyCapture(Phaser.Keyboard.S);
            game.input.keyboard.removeKeyCapture(Phaser.Keyboard.A);
            game.input.keyboard.removeKeyCapture(Phaser.Keyboard.D);
            game.input.keyboard.removeKeyCapture(Phaser.Keyboard.J);
            DebugCount++;
            DebugText.setText("You got to point" + DebugCount + "!");

            PCHeadEquip = new PCEquipProto(1,false, 0, "N/A", "N/A");
            PCChestEquip = new PCEquipProto(1,false, 0, "N/A", "N/A");
            PCWeaponEquip = new PCEquipProto(1,false, 0, "N/A", "N/A");

            var PCPassives = ["N/A", "N/A", "N/A"]

        }
        
        
        function update () {

            //Save the MAXHP at the start of the step before any changes are made

            PCMAXHP = 222;

            PrevMAXHP = PCMAXHP;

            //Updates all stats
            PCSTR = 30 + PCHeadEquip.PCSTRStat + PCChestEquip.PCSTRStat + PCWeaponEquip.PCSTRStat;

            PCPATK = 20 + PCSTR;

            PCPDEF = 5 + (0.1 * PCSTR);

            PCMAXHP = 100 + (0.5 * PCSTR);

            //If the player's current HP exceeds the max HP, cut it down to the max HP
            if (PCCURHP > PCMAXHP){
                console.log("Max HP exceeded, cutting down current HP");
                PCCURHP = PCMAXHP;
            }

            //Check if the MAXHP has changed during this step and if the player was at full health before update the CURHP to match the new MAXHP
            if (PCMAXHP != PrevMAXHP) {
                if (PCCURHP == PrevMAXHP) {
                    PCCURHP = PCMAXHP;
                    console.log("Player was at full health before, matching their hp to their new maximum");
                }
            }


            PCHPText.setText("HP = " + PCCURHP +"/" + PCMAXHP);
           
            PCSTRText.setText("STR = " + PCSTR);
            
            PCPATKText.setText("ATK = " + PCPATK);

            PCPDEFText.setText("DEF = " + PCPDEF);

            //Display the stats of your equipment (if they are equipped)
            //Helmet text display
            if (PCHeadEquip.GotEquip == true) {
                PCHeadEquipText.setText("Your helmet gives you " + PCHeadEquip.PCSTRStat + " STR and " + PCHeadEquip.Passive1 + " " + PCHeadEquip.Passive1X + "%");
            }
            else{
                PCHeadEquipText.setText("You have no helmet equipped.")
            }
            //Chestplate text display
            if (PCChestEquip.GotEquip == true) {
                PCChestEquipText.setText("Your chestplate gives you " + PCChestEquip.PCSTRStat + " STR and " + PCChestEquip.Passive1 + " " + PCChestEquip.Passive1X + "%");
            }
            else{
                PCChestEquipText.setText("You have no chestplate equipped.")
            }
            //Weapon text display
            if (PCWeaponEquip.GotEquip == true) {
                PCWeaponEquipText.setText("Your weapon gives you " + PCWeaponEquip.PCSTRStat + " STR and " + PCWeaponEquip.Passive1 + " " +  PCWeaponEquip.Passive1X + "%");
            }
            else{
                PCWeaponEquipText.setText("You have no weapon equipped.")
            }

        }
        
        function PCMoveUp(){
           PC.y -= 100; 
            DebugCount++;
                DebugText.setText("You got to point" + DebugCount + "!");
        }
        
        function PCMoveDown(){
           PC.y += 100; 
            DebugCount++;
                DebugText.setText("You got to point" + DebugCount + "!");
        }
        
        function PCMoveLeft(){
           PC.x -= 100; 
            DebugCount++;
                DebugText.setText("You got to point" + DebugCount + "!");
        }
        
        function PCMoveRight(){
           PC.x += 100; 
            DebugCount++;
                DebugText.setText("You got to point" + DebugCount + "!");
        }

        /**ITEM GENERATION
         *@param Quality(Param): Comes in 4 qualities (Common, Enchanted, Masterpiece, Mythical. These give modifiers to item stat rolls.
         *@param GotEquip(Param): Is used to show that no actual equipment has been found yet. This will only be true until the player picks up an equip for that slot
         *@param PCSTRStat(Param): Is the amount of STR the item grants.
         *@param Passive1(Param): Is the passive that the item grants. For the full game, items can roll several passives. Follows the convention "Passive X(%)"
         *@param Passive1X(Param): Is the value given to X in passives ie. Passive1(Lifesteal X%) and Passive1X(5) gives Lifesteal 5%
         */

        /**GENERATE QUALITY
         * Use an RNG value from 0 to 100 to determine quality. Quality is an int used as a multiplier for stats and is listed below
         * 1 = Mythical - 3x Mulitplier
         * 2-10 = Masterpiece - 2x Mulitplier
         * 11 - 50 = Magical - 1.5x Mulitplier
         * 51 - 100 = Common - 1xMulitplier
         * @return {*}
         * @constructor
         */
        function GenerateQuality() {

            var RNG = randomIntInRange(1, 101);
            console.log("RNG for quality was rolled as " + RNG);
            if (RNG == 1) {
                return 3;
            }
            else if (RNG > 1 && RNG < 11) {
                return 2;
            }
            else if (RNG > 10 && RNG < 51) {
                return 1.5;
            }
            else {
                return 1;
            }
        }

        function GenerateEnemy(){
            var Quality = GenerateQuality();
            console.log("The Enemy Quality multiplier is " + Quality);
            var GotEquip = true;
            var ENSTRStat = Quality * randomIntInRange(30,40);
            var Passive1 = GeneratePassive(Quality);
            var Passive1X = GeneratePassiveX(Passive1, Quality);
            console.log("the rolled values for a new enemy were " +  Quality + ", " +  GotEquip + ", " +  PCSTRStat + ", " +  Passive1 + ", " +  Passive1X + ", " );
            PCHeadEquip = new PCEquipProto(Quality, GotEquip, ENSTRStat, Passive1, Passive1X);
            //PCPassives[0];
        }

        function EquipTestHelmet(){
            var Quality = GenerateQuality();
            console.log("The Quality multiplier is " + Quality);
            var GotEquip = true;
            var PCSTRStat = Quality * randomIntInRange(5,15);
            var Passive1 = GeneratePassive(Quality);
            var Passive1X = GeneratePassiveX(Passive1, Quality);
            console.log("the rolled values for a new helmet were " +  Quality + ", " +  GotEquip + ", " +  PCSTRStat + ", " +  Passive1 + ", " +  Passive1X + ", " );
            PCHeadEquip = new PCEquipProto(Quality, GotEquip, PCSTRStat, Passive1, Passive1X);
            //PCPassives[0];
        }

        function EquipTestChestPlate(){
            var Quality = GenerateQuality();
            console.log("The Quality multiplier is " + Quality);
            var GotEquip = true;
            var PCSTRStat = Quality * randomIntInRange(15,25);
            var Passive1 = GeneratePassive(Quality);
            var Passive1X = GeneratePassiveX(Passive1, Quality);
            console.log("the rolled values for a new chestplate were " +  Quality + ", " +  GotEquip + ", " +  PCSTRStat + ", " +  Passive1 + ", " +  Passive1X + ", " );
            PCChestEquip = new PCEquipProto(Quality, GotEquip, PCSTRStat, Passive1, Passive1X);
        }

        function EquipTestWeapon(){
            var Quality = GenerateQuality();
            console.log("The Quality multiplier is " + Quality);
            var GotEquip = true;
            var PCSTRStat = Quality * randomIntInRange(25,30);
            var Passive1 = GeneratePassive(Quality);
            var Passive1X = GeneratePassiveX(Passive1, Quality);
            console.log("the rolled values for a new weapon were " +  Quality + ", " +  GotEquip + ", " +  PCSTRStat + ", " +  Passive1 + ", " +  Passive1X + ", " );
            PCWeaponEquip = new PCEquipProto(Quality, GotEquip, PCSTRStat, Passive1, Passive1X);
        }


        function GeneratePassive(Quality){
            var PassiveArray = [
                "Lifesteal", "Critical", "ArmourPierce", "Parry"
            ];
            //
            var ChosenPassive = PassiveArray[Math.floor(Math.random() * PassiveArray.length)];
            console.log("The Passive rolled was " + ChosenPassive);
            return ChosenPassive;

        }

        function PCAttack(PCPATK, PCPassives,EnemyPDEF){

        }

        /**
         *
         * @param ChosenPassive
         * @param Quality
         * @return {number}
         * @constructor
         */
        function GeneratePassiveX(ChosenPassive, Quality){
            //(ChosenPassive.PassMod) *
            var ChosenPassiveX = (Quality * (Math.floor(Math.random()*5)) + 1);
            console.log("The PassiveX rolled was " + ChosenPassiveX);
            return ChosenPassiveX;
        }



        function HurtPlayer(){
            PCCURHP -= 30;
        }

        /**
         *
         * @param QualityParam
         * @param GotEquipParam
         * @param PCSTRStatParam
         * @param Passive1Param
         * @param Passive1XParam
         * @constructor
         */
        function PCEquipProto(QualityParam, GotEquipParam, PCSTRStatParam, Passive1Param, Passive1XParam)
        {
            this.Quality = QualityParam;
            this.GotEquip = GotEquipParam;
            this.PCSTRStat = PCSTRStatParam,
                this.Passive1 = Passive1Param,
                this.Passive1X = Passive1XParam;
        }
    }
        
    </script>

    </body>
</html>